# FFmpeg Screen Recording Implementation

## Изменения

Реализована новая система записи экрана с использованием FFmpeg вместо браузерного API `navigator.mediaDevices.getUserMedia`.

### Основные изменения:

1. **Новый модуль FFmpeg** (`electron/ffmpeg.ts`):
   - Класс `ScreenRecorder` для управления записью
   - Поддержка macOS, Windows и Linux
   - Сохранение видео в формате MP4 с кодеком H.264
   - Автоматическое создание папки для записей на рабочем столе

2. **Обновленные IPC обработчики** (`electron/ipc-handlers/recording.ts`):
   - `START_FFMPEG_RECORDING` - запуск записи
   - `STOP_FFMPEG_RECORDING` - остановка записи
   - `GET_RECORDING_STATUS` - получение статуса записи

3. **Обновленный UI** (`src/views/MainView.vue`):
   - Удален старый код с MediaRecorder
   - Использование новых IPC каналов для FFmpeg
   - Сохранение записей в формате MP4

### Установленные зависимости:
- `fluent-ffmpeg` - Node.js обертка для FFmpeg
- `@ffmpeg-installer/ffmpeg` - Автоматическая установка FFmpeg
- `@types/fluent-ffmpeg` - TypeScript типы

### Настройки FFmpeg:
- **Кодек**: H.264 (libx264)
- **Preset**: ultrafast (для минимальной задержки)
- **CRF**: 23 (хороший баланс качества и размера)
- **Формат пикселей**: yuv420p (совместимость)
- **FPS**: 30

### Платформенные особенности:
- **macOS**: Использует AVFoundation, захват курсора и кликов мыши
- **Windows**: Использует GDI grab
- **Linux**: Использует X11 grab

## Настройка разрешений на macOS

**ВАЖНО**: На macOS необходимо предоставить разрешение на запись экрана:

1. Откройте **Системные настройки** (System Preferences)
2. Перейдите в **Безопасность и конфиденциальность** (Security & Privacy)
3. Выберите вкладку **Конфиденциальность** (Privacy)
4. В левом списке выберите **Запись экрана** (Screen Recording)
5. Нажмите на замок внизу и введите пароль администратора
6. Поставьте галочку напротив вашего приложения (Electron или Terminal)
7. Перезапустите приложение

## Запуск приложения

```bash
# Установка зависимостей
npm install

# Запуск в режиме разработки
npm run electron:dev
```

## Использование

1. Нажмите кнопку "Start Recording" для начала записи
2. Нажмите кнопку "Stop Recording" для остановки
3. Видео сохранится в папку "dst-recorder" на рабочем столе в формате MP4

## Запись аудио

### macOS
По умолчанию записывается системное аудио (`:default`), но для этого требуется:
- Установленный виртуальный аудио драйвер (например, BlackHole или Loopback)
- Настройка виртуального устройства как устройства вывода

**Без дополнительных драйверов:**
- Измените `Capture screen 0:default` на `Capture screen 0:0` для записи с микрофона
- Или `Capture screen 0:none` для записи без звука

### Windows и Linux
Системное аудио записывается автоматически.

## Устранение неполадок

### macOS: "Screen Recording permission required"
Если вы видите эту ошибку, следуйте инструкциям в разделе "Настройка разрешений на macOS" выше.

### Ошибка "ffmpeg exited with code 255"
Это нормальное поведение при остановке записи. Видео должно быть успешно сохранено.

### Видео не записывается
1. Убедитесь, что FFmpeg установлен корректно
2. Проверьте разрешения на запись экрана (macOS)
3. Проверьте наличие папки "dst-recorder" на рабочем столе

### Записывается не тот экран
На macOS с несколькими мониторами:
- По умолчанию записывается внешний монитор (если подключен)
- Индексы экранов в AVFoundation:
  - `0` - встроенный дисплей MacBook
  - `1` - первый внешний монитор
  - `2` - второй внешний монитор и т.д.

Чтобы изменить записываемый экран, измените индекс в файле `electron/ffmpeg.ts`:
```typescript
// Для записи встроенного экрана MacBook
avfScreenIndex = '0'

// Для записи внешнего монитора
avfScreenIndex = '1'
```
